<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神經內科初診單 - 數位填寫版</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS 用於樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 螢幕顯示樣式 */
        .section-title {
            background-color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            border-left: 6px solid #3b82f6;
            font-size: 1.15rem;
        }

        /* Better touch targets */
        .touch-target {
            min-height: 44px;
        }

        .summary-area::-webkit-scrollbar {
            width: 8px;
        }
        .summary-area::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .summary-area::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        .summary-area::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* 列印專用樣式 - A4 優化 */
        @media print {
            @page {
                size: A4;
                margin: 0.8cm;
            }
            .no-print {
                display: none !important;
            }
            body {
                background-color: white;
                font-size: 10pt;
                line-height: 1.2;
            }
            .page-container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            /* 壓縮標題 */
            header {
                margin-bottom: 0.5rem !important;
                padding-bottom: 0.25rem !important;
                border-bottom-width: 1px !important;
            }
            h1 {
                font-size: 1.4rem !important;
                margin-bottom: 0 !important;
            }
            
            /* 壓縮區塊標題 */
            .section-title {
                padding: 2px 8px !important;
                margin-bottom: 0.5rem !important;
                font-size: 0.95rem !important;
                border-left-width: 4px !important;
                background-color: #eee !important;
                -webkit-print-color-adjust: exact;
            }

            /* 壓縮 Grid 間距 */
            .gap-4 { gap: 0.5rem !important; }
            .gap-6 { gap: 0.75rem !important; }
            .gap-8 { gap: 0.75rem !important; }
            .space-y-6 > :not([hidden]) ~ :not([hidden]) {
                margin-top: 0.5rem !important;
            }
            .space-y-4 > :not([hidden]) ~ :not([hidden]) {
                margin-top: 0.35rem !important;
            }
            
            /* 壓縮輸入框與按鈕 */
            .input-box {
                font-size: 0.9rem !important;
                padding: 0 2px !important;
                height: auto !important;
                border: none !important;
                border-bottom: 1px solid #aaa !important;
                border-radius: 0 !important;
                background: transparent !important;
            }
            /* 讓 Radio Card 在列印時看起來像普通的勾選框或純文字 */
            .radio-card, .checkbox-card {
                padding: 2px 4px !important;
                min-width: auto !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                /* 縮放整個元素以節省空間 */
                transform: scale(0.95); 
                transform-origin: center;
                margin: 0 !important;
            }
            .radio-card span, .checkbox-card span {
                font-size: 0.85rem !important;
                font-weight: normal !important;
            }
            /* 被選中的項目加深顏色以便列印識別 */
            .bg-blue-600 {
                background-color: #ddd !important; 
                color: black !important;
                border-color: #000 !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact;
            }
            .text-white {
                color: black !important;
            }
            
            /* Vitals 區塊壓縮 */
            .text-2xl, .text-3xl {
                font-size: 1.1rem !important;
            }
            .bg-blue-50, .bg-red-50, .bg-gray-50, .bg-yellow-50, .bg-orange-50, .bg-pink-50 {
                background-color: transparent !important;
                border: none !important;
                padding: 0 !important;
            }
            
            /* 特定區塊調整 */
            .input-box::placeholder {
                color: transparent !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 優化的大型 Radio 按鈕組件
        const RadioCard = ({ name, value, checked, onChange, label, subLabel }) => (
            <label className={`radio-card relative flex items-center justify-center cursor-pointer border rounded-lg transition-all duration-200 p-3 flex-1 text-center min-w-[80px]
                ${checked ? 'bg-blue-600 border-blue-600 text-white shadow-md transform scale-[1.02]' : 'bg-white border-gray-300 hover:border-blue-400 hover:bg-blue-50 text-gray-700'}`}>
                <input 
                    type="radio" 
                    name={name} 
                    value={value} 
                    checked={checked} 
                    onChange={onChange} 
                    className="hidden" 
                />
                <div className="flex flex-col items-center">
                    <span className={`block font-bold text-base`}>{label}</span>
                    {subLabel && <span className={`block text-xs mt-1 ${checked ? 'text-blue-100' : 'text-gray-500'}`}>{subLabel}</span>}
                </div>
            </label>
        );

        // 像按鈕一樣的 Checkbox
        const CheckboxButton = ({ name, value, checked, onChange, label }) => (
             <label className={`checkbox-card flex items-center justify-center px-4 py-3 rounded-lg border cursor-pointer transition-all duration-200 text-base font-medium select-none
                ${checked ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-gray-300 hover:bg-gray-50 text-gray-700'}`}>
                <input type="checkbox" name={name} value={value} checked={checked} onChange={onChange} className="hidden" />
                <span>{label}</span>
            </label>
        );

        function App() {
            const today = new Date().toISOString().split('T')[0];

            const [formData, setFormData] = useState({
                chartNumber: '',
                visitDate: today,
                visitOrder: '',
                weight: '',
                sbp: '',
                dbp: '',
                hr: '',
                age: '',
                hand: '右手',
                gender: '男',
                diet: '非全素',
                residence: '',
                residenceOther: '',
                marriage: '',
                childrenCount: '',
                jobCategory: '',
                job: '',
                toxicExposure: '',
                toxicExposureDetail: '',
                education: '',
                educationOther: '',
                history: [],
                historyOther: '',
                medications: [],
                medsOther: '',
                medsAntiplateletDetail: '',
                surgery: '無',
                surgeryDetails: '',
                spineSurgery: false,
                cancerSurgery: false,
                familyHistory: '',
                animalsPlants: '無',
                animalsPlantsDetail: '',
                allergies: '無',
                allergyDrug: '',
                allergyFood: '',
                alcohol: '',
                alcoholDetail: '',
                smoking: '',
                smokingPacks: '',
                smokingYears: '',
                quitYears: '',
                travelHistory: [],
                travelHistoryOther: '',
                menopause: '',
                menopauseDate: '',
                pregnancy: '',
                hormoneDrug: ''
            });

            // 生成摘要
            const summaryText = useMemo(() => {
                const {
                    visitDate, chartNumber, age, gender, residence, residenceOther, hand, diet, 
                    marriage, childrenCount, job, jobCategory, education, educationOther, toxicExposure, toxicExposureDetail,
                    history, historyOther, surgery, surgeryDetails, spineSurgery, cancerSurgery, familyHistory,
                    travelHistory, travelHistoryOther, allergies, allergyDrug, allergyFood, alcohol, alcoholDetail, smoking, smokingYears, quitYears,
                    pregnancy, weight, sbp, dbp, hr, animalsPlants, animalsPlantsDetail,
                    menopause, hormoneDrug,
                    medications, medsAntiplateletDetail, medsOther
                } = formData;

                // Line 1: Date
                const line1 = `${visitDate || 'yyyy-mm-dd'} First neuro visit. ${chartNumber ? `(Chart#: ${chartNumber})` : ''}`;

                // Line 2: Demographics
                const sex = gender === '男' ? 'M' : (gender === '女' ? 'F' : '?');
                const loc = residence === '其他' ? (residenceOther || 'Other') : (residence || 'Unknown Loc');
                const hnd = hand === '右手' ? 'RH' : (hand === '左手' ? 'LH' : 'Unknown Hand');
                const veg = diet === '全素' ? 'Veg(+)' : 'Veg(-)';
                
                let marStatus = 'Unknown Marital';
                if (marriage === '已婚') marStatus = 'Married';
                else if (marriage === '未婚') marStatus = 'Single';
                else if (marriage === '離婚') marStatus = 'Divorced';

                let kids = '';
                if ((marriage === '已婚' || marriage === '離婚') && childrenCount) {
                    const parentTitle = gender === '女' ? 'Mother' : (gender === '男' ? 'Father' : 'Parent');
                    kids = `, ${parentTitle} of ${childrenCount}`;
                }

                // Job
                let jobDisplay = jobCategory === '其他' || !jobCategory ? (job || '無') : jobCategory;
                if (jobCategory && jobCategory !== '其他' && job) {
                    jobDisplay = `${jobCategory}(${job})`;
                }
                let jobStr = `Job=${jobDisplay}`;
                
                if (toxicExposure === '是') {
                    jobStr += ` (Toxin+: ${toxicExposureDetail || 'specified'})`;
                }
                
                // Education
                let eduVal = '';
                if (education) {
                    if (education.includes('22')) eduVal = '22';
                    else if (education.includes('18')) eduVal = '18';
                    else if (education.includes('16')) eduVal = '16';
                    else if (education.includes('12')) eduVal = '12';
                    else if (education.includes('9')) eduVal = '9';
                    else if (education.includes('6')) eduVal = '6';
                    else if (education === '未就學') eduVal = '0';
                    else if (education === '其他') eduVal = educationOther || '?';
                    else eduVal = education;
                } else {
                    eduVal = '?';
                }

                const line2 = [
                    age ? `${age} y/o` : 'Age?', 
                    sex, 
                    loc, 
                    hnd, 
                    veg, 
                    marStatus + kids, 
                    jobStr, 
                    `EDU=${eduVal}`
                ].filter(Boolean).join(', ');

                // Line 3: PHx, RHx, SHx, FHx
                const stdDiseases = { 
                    '糖尿病': 'DM', 
                    '高血壓': 'HTN', 
                    '高血脂': 'D/L', 
                    '中風': 'Stroke',
                    '心肌梗塞': 'MI',
                    '癌症': 'Cancer'
                };
                const positives = [];
                const negatives = [];

                Object.keys(stdDiseases).forEach(key => {
                    if (history.includes(key)) {
                        positives.push(`${stdDiseases[key]}(+)`);
                    } else {
                        negatives.push(`${stdDiseases[key]}(-)`);
                    }
                });

                history.forEach(h => {
                    if (!stdDiseases[h] && h !== '其他') positives.push(h);
                });
                if (historyOther) positives.push(historyOther);

                const phxStr = `PHx=${positives.length > 0 ? positives.join(', ') + ', ' : ''}${negatives.join(', ')}`;
                
                // RHx (Medications) Logic
                const medsList = [];
                if (medications.includes('抗血小板/抗凝血藥物')) {
                    medsList.push(`Antiplatelet(${medsAntiplateletDetail || '+'})`);
                }
                if (medications.includes('心律不整藥物')) medsList.push('Anti-arrhythmic');
                if (medications.includes('中藥')) medsList.push('TCM');
                if (medications.includes('其他')) {
                    medsList.push(medsOther || 'Other Meds');
                }
                const rhxStr = medsList.length > 0 ? `RHx=${medsList.join('/')}` : 'RHx=0';

                // SHx
                const surgs = [];
                if (spineSurgery) surgs.push("Spine Sx");
                if (cancerSurgery) surgs.push("Cancer Sx");
                if (surgeryDetails) surgs.push(surgeryDetails);
                const shx = (surgery === '有' || surgs.length > 0) ? `SHx=${surgs.join('/') || 'Yes'}` : 'SHx=0';
                
                // FHx
                const fhx = familyHistory ? `FHx=${familyHistory}` : 'FHx=0';

                const line3 = [phxStr, rhxStr, shx, fhx].join(', ');

                // Line 4: Habits/History
                const travelArr = [...travelHistory];
                if (travelHistoryOther) travelArr.push(travelHistoryOther);
                const trav = travelArr.length > 0 ? `Travel(${travelArr.join(',')})` : 'Travel(-)';
                
                let alg = 'Allergy(-)';
                if (allergies === '有') {
                    const parts = [];
                    if (allergyDrug) parts.push(allergyDrug);
                    if (allergyFood) parts.push(allergyFood);
                    alg = `Allergy(${parts.join('/') || '+'})`;
                }

                let animal = 'Animal(-)';
                if (animalsPlants === '有') {
                    animal = `Animal(${animalsPlantsDetail || '+'})`;
                }

                let alc = 'Alc(-)';
                if (alcohol === '有') alc = `Alc(+${alcoholDetail ? `: ${alcoholDetail}` : ''})`;
                if (alcohol === '小酌') alc = 'Alc(Social)';

                let smk = 'Smk(-)';
                if (smoking === '有') {
                    smk = `Smk(+)${smokingYears ? `, ${smokingYears}y` : ''}`;
                } else if (smoking === '已戒菸') {
                    smk = `Smk(Quit${smokingYears ? `, smoked ${smokingYears}y` : ''}${quitYears ? `, quit ${quitYears}y` : ''})`;
                }

                const line4 = [trav, animal, alg, alc, smk].join(', ');

                // Line 5: Gynecology
                let line5 = '';
                if (gender === '女') {
                    const parts = [];
                    if (menopause === '已停經') parts.push('MC(-)');
                    else if (menopause === '規則') parts.push('MC(R)');
                    else if (menopause === '不規則') parts.push('MC(IR)');

                    if (pregnancy === '確認無') parts.push('Pregnancy: Denied');
                    else if (pregnancy === '可能/準備中') parts.push('Pregnancy: Possible/Planning');

                    if (hormoneDrug === '是') parts.push('HRT(+)');
                    else if (hormoneDrug === '否') parts.push('HRT(-)');

                    line5 = parts.join(', ');
                }

                // Line 6: Vitals
                const line6 = `Bwt: ${weight || '_'}  BP: ${sbp || '_'}/${dbp || '_'}${hr ? ` HR: ${hr}` : ''}`;

                return [line1, line2, line3, line4, line5, line6].filter(Boolean).join('\n');
            }, [formData]);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                
                if (type === 'checkbox') {
                    if (name === 'spineSurgery' || name === 'cancerSurgery') {
                         setFormData(prev => ({ ...prev, [name]: checked }));
                    } else if (name === 'travelHistory') {
                        setFormData(prev => {
                            const current = prev.travelHistory || [];
                            if (checked) return { ...prev, travelHistory: [...current, value] };
                            return { ...prev, travelHistory: current.filter(item => item !== value) };
                        });
                    } else {
                        if (checked) {
                            setFormData(prev => ({ ...prev, [name]: [...(prev[name] || []), value] }));
                        } else {
                            setFormData(prev => ({ ...prev, [name]: (prev[name] || []).filter(item => item !== value) }));
                        }
                    }
                } else {
                    if (name === 'menopause' && value === '已停經') {
                        setFormData(prev => ({ ...prev, [name]: value, pregnancy: '確認無' }));
                    } else {
                        setFormData(prev => ({ ...prev, [name]: value }));
                    }
                }
            };

            const handleSimpleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handlePrint = () => {
                window.print();
            };

            const copySummary = () => {
                navigator.clipboard.writeText(summaryText);
                const btn = document.getElementById('copy-btn');
                const originalText = btn.innerText;
                btn.innerText = '已複製！';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            };

            return (
                <div className="min-h-screen py-6 px-4 flex justify-center print:p-0">
                    <div className="page-container bg-white w-full max-w-5xl rounded-xl shadow-lg p-6 space-y-6 print:shadow-none print:w-full">
                        
                        {/* 標題區 */}
                        <header className="flex justify-between items-end border-b-2 border-gray-200 pb-2 mb-4">
                            <div>
                                <h1 className="text-3xl font-extrabold text-gray-900 tracking-wide">神經內科初診單</h1>
                                <p className="text-sm text-red-500 font-medium print:hidden mt-1">
                                    ※ 該問卷僅供門診使用，並不會作為參與研究計畫或其他用途。
                                </p>
                            </div>
                            <div className="text-right text-sm text-gray-500">
                                2024.09.12 廖誼佳醫師 (Rev. 2026.01)
                            </div>
                        </header>

                        {/* 1. Admin Info (Chart, Date, Order) */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-blue-50 p-4 rounded-xl border border-blue-100 print:bg-transparent print:border-none print:p-0">
                            <div>
                                <label className="text-sm font-bold text-gray-600 uppercase mb-1 block">Chart No. 病歷號</label>
                                <input type="text" name="chartNumber" value={formData.chartNumber} onChange={handleChange} 
                                    className="input-box w-full font-mono text-xl font-bold text-gray-800 bg-white rounded border border-gray-300 px-3 py-2" placeholder="請輸入" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-600 uppercase mb-1 block">Date 日期</label>
                                <input type="date" name="visitDate" value={formData.visitDate} onChange={handleChange} 
                                    className="input-box w-full text-lg bg-white rounded border border-gray-300 px-3 py-2" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-600 uppercase mb-1 block">Order 診號</label>
                                <input type="text" name="visitOrder" value={formData.visitOrder} onChange={handleChange} 
                                    className="input-box w-full text-lg bg-white rounded border border-gray-300 px-3 py-2" />
                            </div>
                        </div>

                        {/* 2. Vitals (New Independent Row) - Weight, SBP, DBP, HR */}
                        <div className="bg-red-50 p-4 rounded-xl border border-red-100 flex flex-col md:flex-row gap-6 items-center print:bg-transparent print:border-none print:p-0 print:border-b print:border-black">
                            {/* Weight */}
                            <div className="w-full md:w-1/4">
                                <label className="text-sm font-bold text-gray-600 uppercase mb-1 block">Weight 體重 (kg)</label>
                                <input type="number" name="weight" value={formData.weight} onChange={handleChange} 
                                    className="input-box w-full text-2xl font-bold text-center bg-white rounded border border-red-200 px-3 py-2" placeholder="kg" />
                            </div>

                            {/* BP Group */}
                            <div className="w-full md:flex-grow flex flex-col md:flex-row gap-2 items-center">
                                <div className="flex-grow w-full">
                                    <label className="text-xs font-bold text-gray-500 mb-1 block text-center">收縮壓 SBP</label>
                                    <input type="number" name="sbp" value={formData.sbp} onChange={handleChange} 
                                        className="input-box w-full text-center text-3xl font-bold bg-white rounded-lg border border-red-200 py-2 shadow-sm" placeholder="mmHg" />
                                </div>
                                <span className="text-3xl text-gray-400 pt-6">/</span>
                                <div className="flex-grow w-full">
                                    <label className="text-xs font-bold text-gray-500 mb-1 block text-center">舒張壓 DBP</label>
                                    <input type="number" name="dbp" value={formData.dbp} onChange={handleChange} 
                                        className="input-box w-full text-center text-3xl font-bold bg-white rounded-lg border border-red-200 py-2 shadow-sm" placeholder="mmHg" />
                                </div>
                            </div>
                            
                            {/* HR */}
                            <div className="w-full md:w-1/4">
                                <label className="text-xs font-bold text-gray-500 mb-1 block text-center">心跳 HR</label>
                                <div className="relative">
                                    <input type="number" name="hr" value={formData.hr} onChange={handleChange} 
                                        className="input-box w-full text-center text-2xl font-bold bg-white rounded border border-red-200 px-3 py-2" placeholder="bpm" />
                                </div>
                            </div>
                        </div>

                        {/* 3. Basic Demographics */}
                        <div className="flex flex-col gap-6 space-y-4">
                            
                            {/* Row 1: Age, Gender, Hand, Diet */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-gray-50 p-3 rounded-lg">
                                    <label className="text-sm font-bold text-gray-500 block mb-2">Age 年齡</label>
                                    <div className="flex items-center">
                                        <input type="number" name="age" value={formData.age} onChange={handleChange} className="input-box w-full text-2xl text-center font-bold bg-white rounded border border-gray-300 py-2" />
                                        <span className="ml-2 font-bold text-gray-500">歲</span>
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg">
                                    <label className="text-sm font-bold text-gray-500 block mb-2">Sex 生理性別</label>
                                    <div className="flex gap-2">
                                        <RadioCard name="gender" value="男" checked={formData.gender === '男'} onChange={handleChange} label="男" subLabel="Male" />
                                        <RadioCard name="gender" value="女" checked={formData.gender === '女'} onChange={handleChange} label="女" subLabel="Female" />
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg">
                                    <label className="text-sm font-bold text-gray-500 block mb-2">Hand 慣用手</label>
                                    <div className="flex gap-2">
                                        <RadioCard name="hand" value="右手" checked={formData.hand === '右手'} onChange={handleChange} label="右手" />
                                        <RadioCard name="hand" value="左手" checked={formData.hand === '左手'} onChange={handleChange} label="左手" />
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg">
                                    <label className="text-sm font-bold text-gray-500 block mb-2">Diet 飲食習慣</label>
                                    <div className="flex gap-2">
                                        <RadioCard name="diet" value="非全素" checked={formData.diet === '非全素'} onChange={handleChange} label="葷/蛋奶" />
                                        <RadioCard name="diet" value="全素" checked={formData.diet === '全素'} onChange={handleChange} label="全素" />
                                    </div>
                                </div>
                            </div>

                            {/* Row 2: Marriage, Residence */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                
                                {/* Marriage */}
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-gray-700">婚姻狀況</label>
                                    <div className="flex gap-2">
                                        <RadioCard name="marriage" value="未婚" checked={formData.marriage === '未婚'} onChange={handleChange} label="未婚" />
                                        <RadioCard name="marriage" value="已婚" checked={formData.marriage === '已婚'} onChange={handleChange} label="已婚" />
                                        <RadioCard name="marriage" value="離婚" checked={formData.marriage === '離婚'} onChange={handleChange} label="離婚" />
                                    </div>
                                    {(formData.marriage === '已婚' || formData.marriage === '離婚') && (
                                        <div className="flex items-center bg-gray-50 p-3 rounded border border-gray-200 mt-2">
                                            <span className="text-base font-medium mr-2">育有</span>
                                            <input type="number" name="childrenCount" value={formData.childrenCount} onChange={handleChange} className="input-box w-16 text-center text-lg border-b-2 border-gray-400" />
                                            <span className="text-base font-medium ml-2">名子女</span>
                                        </div>
                                    )}
                                </div>

                                {/* Residence */}
                                <div className="space-y-2">
                                    <label className="text-sm font-bold text-gray-700">居住地</label>
                                    <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                        {['宜蘭市', '羅東', '礁溪', '頭城', '壯圍', '員山', '台北', '其他'].map(place => (
                                            <label key={place} className={`cursor-pointer py-2 px-1 text-center text-sm font-medium rounded border transition-colors 
                                                ${formData.residence === place ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}>
                                                <input type="radio" name="residence" value={place} checked={formData.residence === place} onChange={handleChange} className="hidden" />
                                                {place}
                                            </label>
                                        ))}
                                    </div>
                                    {formData.residence === '其他' && (
                                        <input type="text" name="residenceOther" value={formData.residenceOther} onChange={handleChange} className="input-box w-full mt-2 p-2 bg-white border border-gray-300 rounded" placeholder="請輸入地點" />
                                    )}
                                </div>
                            </div>
                        </div>

                        <hr className="border-gray-200 my-2" />

                        {/* 4. Social History */}
                        <section>
                            <div className="section-title">社會背景 Social History</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    {/* Job */}
                                    <div>
                                        <label className="text-base font-bold text-gray-700 block mb-2">職業 Job</label>
                                        <div className="flex flex-wrap gap-2 mb-2">
                                            {['家管', '農', '商', '軍', '工', '其他'].map(cat => (
                                                <label key={cat} className={`cursor-pointer px-4 py-2 rounded-lg border text-sm font-medium transition-colors
                                                    ${formData.jobCategory === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-100 border-gray-300'}`}>
                                                    <input type="radio" name="jobCategory" value={cat} checked={formData.jobCategory === cat} onChange={handleChange} className="hidden" />
                                                    {cat}
                                                </label>
                                            ))}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm font-bold text-gray-500 whitespace-nowrap">詳細職稱:</span>
                                            <input type="text" name="job" value={formData.job} onChange={handleChange} 
                                                className="input-box w-full p-2 border border-gray-300 rounded bg-white" placeholder="例如：業務經理、水泥工..." />
                                        </div>
                                    </div>
                                    
                                    {/* Toxin */}
                                    <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-orange-900">接觸化學/揮發物質?</span>
                                            <div className="flex gap-2">
                                                <RadioCard name="toxicExposure" value="否" checked={formData.toxicExposure === '否'} onChange={handleChange} label="否" />
                                                <RadioCard name="toxicExposure" value="是" checked={formData.toxicExposure === '是'} onChange={handleChange} label="是" />
                                            </div>
                                        </div>
                                        {formData.toxicExposure === '是' && (
                                            <input type="text" name="toxicExposureDetail" value={formData.toxicExposureDetail} onChange={handleChange} 
                                                className="input-box w-full mt-2 p-2 bg-white border border-orange-200 rounded" placeholder="請說明物質..." />
                                        )}
                                    </div>
                                </div>
                                
                                <div>
                                    {/* Education - Larger Fonts */}
                                    <label className="text-base font-bold text-gray-700 block mb-3">教育程度 Education</label>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        {[
                                            {v: '未就學', l: '未就學'}, {v: '國小(6)', l: '國小(6)'}, 
                                            {v: '國中(9)', l: '國中(9)'}, {v: '高中(12)', l: '高中(12)'}, 
                                            {v: '大學(16)', l: '大學(16)'}, {v: '碩士(18)', l: '碩士(18)'}, 
                                            {v: '博士(22)', l: '博士(22)'}, {v: '其他', l: '其他'}
                                        ].map(edu => (
                                            <label key={edu.v} className={`cursor-pointer border p-3 text-center text-base font-medium rounded-lg shadow-sm transition-all
                                                ${formData.education === edu.v ? 'bg-blue-600 text-white border-blue-600 transform scale-105' : 'bg-white text-gray-700 hover:bg-gray-50 border-gray-200'}`}>
                                                <input type="radio" name="education" value={edu.v} checked={formData.education === edu.v} onChange={handleChange} className="hidden" />
                                                {edu.l}
                                            </label>
                                        ))}
                                    </div>
                                    {formData.education === '其他' && (
                                        <input type="text" name="educationOther" value={formData.educationOther} onChange={handleChange} 
                                            className="input-box w-full mt-3 p-2 border border-gray-300 rounded bg-white" placeholder="請說明" />
                                    )}
                                </div>
                            </div>
                        </section>

                        {/* 5. Medical History */}
                        <section>
                            <div className="section-title">過去病史 Past History</div>
                            <div className="space-y-6">
                                {/* Diseases - Grid layout for buttons */}
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                    {[
                                        {v: '糖尿病', l: '糖尿病 (DM)'}, 
                                        {v: '高血壓', l: '高血壓 (HTN)'}, 
                                        {v: '高血脂', l: '高血脂'}, 
                                        {v: '中風', l: '中風 (Stroke)'}, 
                                        {v: '心肌梗塞', l: '心肌梗塞 (MI)'},
                                        {v: '癌症', l: '癌症 (Cancer)'},
                                        {v: '其他', l: '其他'}
                                    ].map(d => (
                                        <CheckboxButton key={d.v} name="history" value={d.v} checked={formData.history.includes(d.v)} onChange={handleChange} label={d.l} />
                                    ))}
                                </div>
                                {formData.history.includes('其他') && (
                                    <input type="text" name="historyOther" value={formData.historyOther} onChange={handleChange} 
                                        className="input-box w-full p-3 bg-white border border-gray-300 rounded-lg text-lg" placeholder="請補充其他病史..." />
                                )}

                                {/* Meds */}
                                <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                    <label className="text-base font-bold text-yellow-900 block mb-3">目前服用藥物</label>
                                    <div className="flex flex-wrap gap-3">
                                        <CheckboxButton name="medications" value="抗血小板/抗凝血藥物" checked={formData.medications.includes('抗血小板/抗凝血藥物')} onChange={handleChange} label="抗血小板/抗凝血" />
                                        <CheckboxButton name="medications" value="心律不整藥物" checked={formData.medications.includes('心律不整藥物')} onChange={handleChange} label="心律不整" />
                                        <CheckboxButton name="medications" value="中藥" checked={formData.medications.includes('中藥')} onChange={handleChange} label="中藥" />
                                        <CheckboxButton name="medications" value="其他" checked={formData.medications.includes('其他')} onChange={handleChange} label="其他" />
                                    </div>
                                    
                                    {/* Detail Inputs for Meds */}
                                    <div className="mt-3 space-y-2">
                                        {formData.medications.includes('抗血小板/抗凝血藥物') && (
                                            <div className="flex items-center gap-2 animate-fade-in">
                                                <span className="text-sm font-bold text-yellow-800">藥名 (抗血小板):</span>
                                                <input type="text" name="medsAntiplateletDetail" value={formData.medsAntiplateletDetail} onChange={handleChange} className="input-box flex-grow p-2 bg-white border border-yellow-300 rounded" placeholder="例如: Bokey, Plavix..." />
                                            </div>
                                        )}
                                        {formData.medications.includes('其他') && (
                                            <div className="flex items-center gap-2 animate-fade-in">
                                                <span className="text-sm font-bold text-yellow-800">其他藥物:</span>
                                                <input type="text" name="medsOther" value={formData.medsOther} onChange={handleChange} className="input-box flex-grow p-2 bg-white border border-yellow-300 rounded" placeholder="請填寫" />
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Surgery - Conditional Reveal */}
                                <div className="p-4 rounded-xl border border-gray-200 bg-gray-50">
                                    <div className="flex items-center justify-between">
                                        <label className="text-base font-bold text-gray-700">手術史 (SHx)</label>
                                        <div className="flex gap-4">
                                            <RadioCard name="surgery" value="無" checked={formData.surgery === '無'} onChange={handleChange} label="無" />
                                            <RadioCard name="surgery" value="有" checked={formData.surgery === '有'} onChange={handleChange} label="有" />
                                        </div>
                                    </div>
                                    
                                    {/* Only show details if YES is selected */}
                                    {formData.surgery === '有' && (
                                        <div className="mt-4 pt-4 border-t border-gray-200 animate-fade-in">
                                            <div className="flex flex-wrap gap-4 mb-3">
                                                <label className="flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 shadow-sm">
                                                    <input type="checkbox" name="spineSurgery" checked={formData.spineSurgery} onChange={handleChange} className="w-5 h-5 text-blue-600 mr-2" />
                                                    <span className="font-bold text-gray-700">脊椎手術</span>
                                                </label>
                                                <label className="flex items-center p-3 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 shadow-sm">
                                                    <input type="checkbox" name="cancerSurgery" checked={formData.cancerSurgery} onChange={handleChange} className="w-5 h-5 text-blue-600 mr-2" />
                                                    <span className="font-bold text-gray-700">癌症手術</span>
                                                </label>
                                            </div>
                                            <input type="text" name="surgeryDetails" value={formData.surgeryDetails} onChange={handleChange} 
                                                className="input-box w-full p-3 bg-white border border-gray-300 rounded-lg" placeholder="請說明其他手術項目及大致年份..." />
                                        </div>
                                    )}
                                </div>
                                
                                {/* Family History */}
                                <div>
                                    <label className="text-sm font-bold text-gray-700 block mb-2">家族病史 Family History</label>
                                    <input type="text" name="familyHistory" value={formData.familyHistory} onChange={handleChange} 
                                        className="input-box w-full p-3 border border-gray-300 rounded-lg bg-white" placeholder="無，或請詳述 (例如: 父親有中風、母親有失智...)" />
                                </div>
                            </div>
                        </section>

                        {/* 6. Habits & Exposure */}
                        <section>
                            <div className="section-title">習慣與接觸史 Habits & Exposure</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    {/* Allergies */}
                                    <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="font-bold text-red-900">過敏史 Allergies</span>
                                            <div className="flex gap-2">
                                                <RadioCard name="allergies" value="無" checked={formData.allergies === '無'} onChange={handleChange} label="無" />
                                                <RadioCard name="allergies" value="有" checked={formData.allergies === '有'} onChange={handleChange} label="有" />
                                            </div>
                                        </div>
                                        {formData.allergies === '有' && (
                                            <div className="space-y-3 animate-fade-in">
                                                <div className="flex items-center gap-2">
                                                    <span className="w-12 font-bold text-red-700">藥物</span>
                                                    <input type="text" name="allergyDrug" value={formData.allergyDrug} onChange={handleChange} className="input-box flex-grow bg-white border border-red-200 rounded p-2" placeholder="藥名" />
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="w-12 font-bold text-red-700">食物</span>
                                                    <input type="text" name="allergyFood" value={formData.allergyFood} onChange={handleChange} className="input-box flex-grow bg-white border border-red-200 rounded p-2" placeholder="食物" />
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Animals/Plants - Improved */}
                                    <div className="p-4 rounded-xl border border-gray-200 bg-white">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="font-bold text-gray-700">動/植物接觸</span>
                                            <div className="flex gap-2">
                                                <RadioCard name="animalsPlants" value="無" checked={formData.animalsPlants === '無'} onChange={handleChange} label="無" />
                                                <RadioCard name="animalsPlants" value="有" checked={formData.animalsPlants === '有'} onChange={handleChange} label="有" />
                                            </div>
                                        </div>
                                        {formData.animalsPlants === '有' && (
                                            <input type="text" name="animalsPlantsDetail" value={formData.animalsPlantsDetail} onChange={handleChange} 
                                                className="input-box w-full p-2 border border-gray-300 rounded bg-gray-50" placeholder="請說明 (例如: 養貓、種蘭花...)" />
                                        )}
                                    </div>
                                    
                                    {/* Travel - Multi-select */}
                                    <div>
                                        <span className="text-base font-bold block mb-3 text-gray-700">旅遊史 (近3個月) - 可複選</span>
                                        <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                            {['無', '台灣', '日本', '韓國', '美國', '中國', '越南', '泰國'].map(loc => (
                                                <label key={loc} className={`cursor-pointer py-2 px-1 text-center text-sm font-medium rounded border transition-colors select-none
                                                    ${formData.travelHistory.includes(loc) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}>
                                                    <input type="checkbox" name="travelHistory" value={loc} checked={formData.travelHistory.includes(loc)} onChange={handleChange} className="hidden" />
                                                    {loc}
                                                </label>
                                            ))}
                                        </div>
                                        <input type="text" name="travelHistoryOther" value={formData.travelHistoryOther} onChange={handleChange} 
                                            className="input-box w-full mt-3 p-2 border border-gray-300 rounded bg-white" placeholder="其他地點..." />
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    {/* Alcohol */}
                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                        <label className="text-base font-bold text-gray-700 block mb-2">飲酒習慣 Alcohol</label>
                                        <div className="flex gap-3 mb-2">
                                            <RadioCard name="alcohol" value="無" checked={formData.alcohol === '無'} onChange={handleChange} label="無" />
                                            <RadioCard name="alcohol" value="小酌" checked={formData.alcohol === '小酌'} onChange={handleChange} label="小酌" subLabel="Social" />
                                            <RadioCard name="alcohol" value="有" checked={formData.alcohol === '有'} onChange={handleChange} label="有" />
                                        </div>
                                        {/* Added conditional text input for alcohol detail */}
                                        {formData.alcohol === '有' && (
                                            <div className="animate-fade-in mt-3">
                                                 <input type="text" name="alcoholDetail" value={formData.alcoholDetail} onChange={handleChange} 
                                                    className="input-box w-full p-2 border border-gray-300 rounded bg-white" placeholder="請說明 (例如: 每天高粱半杯)" />
                                            </div>
                                        )}
                                    </div>

                                    {/* Smoking */}
                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                        <label className="text-base font-bold text-gray-700 block mb-3">抽菸習慣 Smoking</label>
                                        <div className="grid grid-cols-1 gap-3 mb-4">
                                            <RadioCard name="smoking" value="無" checked={formData.smoking === '無'} onChange={handleChange} label="無 Never" />
                                            <RadioCard name="smoking" value="已戒菸" checked={formData.smoking === '已戒菸'} onChange={handleChange} label="已戒菸 Quit" />
                                            <RadioCard name="smoking" value="有" checked={formData.smoking === '有'} onChange={handleChange} label="有 Active" />
                                        </div>
                                        
                                        {formData.smoking === '有' && (
                                            <div className="animate-fade-in bg-white p-3 rounded border border-gray-300 flex flex-wrap gap-2 items-center justify-center">
                                                <span>一天</span>
                                                <input type="number" name="smokingPacks" value={formData.smokingPacks} onChange={handleChange} className="input-box w-16 text-center border rounded p-1" />
                                                <span>包，已抽</span>
                                                <input type="number" name="smokingYears" value={formData.smokingYears} onChange={handleChange} className="input-box w-16 text-center border rounded p-1" />
                                                <span>年</span>
                                            </div>
                                        )}
                                        {formData.smoking === '已戒菸' && (
                                            <div className="animate-fade-in bg-white p-3 rounded border border-gray-300 flex flex-wrap gap-2 items-center justify-center">
                                                <span>共抽</span>
                                                <input type="number" name="smokingYears" value={formData.smokingYears} onChange={handleChange} className="input-box w-16 text-center border rounded p-1" />
                                                <span>年，已戒</span>
                                                <input type="number" name="quitYears" value={formData.quitYears} onChange={handleChange} className="input-box w-16 text-center border rounded p-1" />
                                                <span>年</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* Female Only */}
                        {formData.gender === '女' && (
                            <section className="bg-pink-50 p-6 rounded-2xl border-2 border-pink-200 shadow-sm animate-fade-in">
                                <h3 className="text-pink-800 font-bold text-lg mb-4 flex items-center">
                                    <span className="bg-pink-200 text-pink-800 px-2 py-1 rounded text-xs mr-2">女性專屬</span>
                                    婦科病史 Gynecologic History
                                </h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {/* Menopause */}
                                    <div className="bg-white p-4 rounded-xl border border-pink-100">
                                        <label className="block text-sm font-bold text-pink-900 mb-2">月經狀況</label>
                                        <div className="flex flex-col gap-2">
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="menopause" value="已停經" checked={formData.menopause === '已停經'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />已停經</label>
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="menopause" value="不規則" checked={formData.menopause === '不規則'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />不規則</label>
                                            <div className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer">
                                                <input type="radio" name="menopause" value="規則" checked={formData.menopause === '規則'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />
                                                <span>規則</span>
                                            </div>
                                            {formData.menopause === '規則' && (
                                                <div className="ml-7 text-sm">
                                                    上次: <input type="date" name="menopauseDate" value={formData.menopauseDate} onChange={handleChange} className="border border-pink-300 rounded p-1" />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Pregnancy */}
                                    <div className="bg-white p-4 rounded-xl border border-pink-100">
                                        <label className="block text-sm font-bold text-pink-900 mb-2">懷孕狀況</label>
                                        <div className="flex flex-col gap-2">
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="pregnancy" value="確認無" checked={formData.pregnancy === '確認無'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />確認無</label>
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="pregnancy" value="可能/準備中" checked={formData.pregnancy === '可能/準備中'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />可能/準備中</label>
                                        </div>
                                    </div>

                                    {/* Hormone */}
                                    <div className="bg-white p-4 rounded-xl border border-pink-100">
                                        <label className="block text-sm font-bold text-pink-900 mb-2">使用賀爾蒙藥物?</label>
                                        <div className="flex flex-col gap-2">
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="hormoneDrug" value="否" checked={formData.hormoneDrug === '否'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />否</label>
                                            <label className="flex items-center p-2 hover:bg-pink-50 rounded cursor-pointer"><input type="radio" name="hormoneDrug" value="是" checked={formData.hormoneDrug === '是'} onChange={handleChange} className="mr-2 w-5 h-5 accent-pink-600" />是</label>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        )}

                        {/* Summary Section */}
                        <section className="no-print mt-6 bg-slate-800 text-white p-5 rounded-2xl shadow-xl">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold flex items-center text-base">
                                    <span className="w-3 h-3 bg-green-400 rounded-full mr-2 shadow-[0_0_10px_#4ade80]"></span>
                                    病歷摘要生成 (Auto-Summary)
                                </h3>
                                <button id="copy-btn" onClick={copySummary} className="bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm px-6 py-2 rounded-lg transition-all shadow-lg active:transform active:scale-95">
                                    複製 Copy
                                </button>
                            </div>
                            <textarea 
                                readOnly 
                                value={summaryText} 
                                className="summary-area w-full h-40 bg-slate-900 text-green-300 font-mono text-base p-4 rounded-xl border border-slate-700 focus:outline-none focus:border-green-500 shadow-inner"
                            ></textarea>
                            <p className="text-gray-400 text-xs mt-2 text-right">Tip: 上方欄位填寫越完整，此摘要越準確。</p>
                        </section>

                        <footer className="no-print mt-12 mb-8 flex justify-center">
                            <button onClick={handlePrint} className="bg-white border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-50 hover:border-gray-400 flex items-center shadow-sm font-bold text-lg transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                                列印本頁 / 存成 PDF
                            </button>
                        </footer>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
