<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>失智評估初診問卷</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            background-color: #f1f5f9;
            font-family: 'Noto Sans TC', "Microsoft JhengHei", sans-serif;
            color: #334155;
            /* 基礎字體稍微加大以利閱讀 */
            font-size: 17px;
        }
        
        /* --- 自定義 Radio & Checkbox 美化 (加大尺寸適合平板) --- */
        input[type="radio"], input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            /* 加大尺寸至 1.6em */
            width: 1.6em;
            height: 1.6em;
            border: 2px solid #cbd5e1;
            display: grid;
            place-content: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 0.75rem; /* 增加與文字的間距 */
            position: relative;
            top: 2px;
        }

        input[type="radio"] {
            border-radius: 50%;
        }
        
        input[type="checkbox"] {
            border-radius: 0.4em;
        }

        input[type="radio"]::before {
            content: "";
            width: 0.8em; /* 加大圓點 */
            height: 0.8em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb;
        }

        input[type="checkbox"]::before {
            content: "";
            width: 0.8em; /* 加大打勾 */
            height: 0.8em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #2563eb;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        input[type="radio"]:checked, input[type="checkbox"]:checked {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        input[type="radio"]:checked::before, input[type="checkbox"]:checked::before {
            transform: scale(1);
        }

        input:disabled {
            border-color: #e2e8f0;
            background-color: #f1f5f9;
            cursor: not-allowed;
        }
        /* --- 結束自定義樣式 --- */

        .section-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            padding: 2.5rem; /* 加大內距 */
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 1.4rem; /* 加大標題 */
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1.75rem;
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 1.6em;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            margin-right: 1rem;
            border-radius: 99px;
        }

        /* 優化輸入底線模式 */
        .input-underline {
            border: none;
            border-bottom: 2px solid #cbd5e1; /* 加深顏色增加對比 */
            border-radius: 0;
            padding: 0.5rem 0.75rem; /* 加大點擊範圍 */
            background: transparent;
            transition: all 0.3s;
            width: 100%;
            font-size: 1.1rem; /* 加大輸入字體 */
        }
        .input-underline:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        /* 優化輸入框模式 */
        .input-box {
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 0.85rem; /* 加大內距適合手指點擊 */
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 1.1rem;
        }
        .input-box:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); /* 加大 focus 光暈 */
        }

        /* 按鈕優化 */
        .btn-pill {
            padding: 0.5rem 1.25rem; /* 加大按鈕尺寸 */
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 80px; /* 確保最小寬度好點擊 */
        }
        .btn-normal {
            background-color: #ecfccb;
            color: #365314;
            border-color: #d9f99d;
        }
        .btn-normal:hover { background-color: #d9f99d; }
        
        .btn-abnormal {
            background-color: #fee2e2;
            color: #7f1d1d;
            border-color: #fecaca;
        }
        .btn-abnormal:hover { background-color: #fecaca; }

        .btn-pill:active { transform: scale(0.95); }

        .reveal-input {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            margin-top: 0;
        }
        .reveal-input.show {
            max-height: 80px; /* 增加高度以容納更大的輸入框 */
            opacity: 1;
            margin-top: 1rem;
        }

        label {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            padding: 0.6rem 0.25rem; /* 增加垂直間距，避免誤觸上下行 */
            width: 100%; /* 讓點擊範圍延伸 */
        }
        
        .bpsd-row {
            transition: background-color 0.2s;
        }
        .bpsd-row:hover {
            background-color: #f8fafc;
        }
        
        /* 網格間距調整 */
        .grid-gap-tablet {
            gap: 1.5rem; /* 增加 grid 間距 */
        }
    </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto bg-slate-50">

    <header class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 tracking-tight">失智評估初診問卷</h1>
        <p class="text-gray-500 mt-3 text-lg">請依照患者實際狀況填寫，以利醫師評估</p>
    </header>

    <form id="assessmentForm" onchange="updateSummary()">
        
        <!-- 研究同意 -->
        <div class="section-card border-l-8 border-l-blue-500 bg-blue-50/40">
            <div class="flex items-start">
                <label for="research_consent" class="text-gray-800 font-bold text-xl py-2">
                    <input type="checkbox" id="research_consent" name="research_consent" class="mt-1">
                    本人同意提供此問卷資料供學術研究使用（資料將去識別化處理）
                </label>
            </div>
        </div>

        <!-- 基本資料 -->
        <div class="section-card">
            <div class="section-title">1. 基本資訊</div>
            
            <div class="grid md:grid-cols-2 grid-gap-tablet">
                <!-- 填寫人關係 -->
                <div>
                    <h3 class="text-base font-bold text-gray-500 uppercase tracking-wider mb-4">填寫人之關係</h3>
                    <div class="flex flex-wrap gap-y-2 gap-x-6">
                        <label class="w-auto"><input type="radio" name="relationship" value="Patient"> 本人</label>
                        <label class="w-auto"><input type="radio" name="relationship" value="Spouse"> 配偶</label>
                        <label class="w-auto"><input type="radio" name="relationship" value="Children"> 子女/媳婿</label>
                        <label class="w-auto"><input type="radio" name="relationship" value="Sibling"> 兄弟姊妹</label>
                        <div class="flex items-center w-full sm:w-auto">
                            <label class="w-auto mr-2"><input type="radio" name="relationship" value="Other" class="toggle-other" data-target="rel_other"> 其他</label>
                            <input type="text" id="rel_other" class="input-underline flex-1 min-w-[150px] opacity-50 focus:opacity-100" placeholder="請輸入" disabled>
                        </div>
                    </div>
                </div>

                <!-- 轉介單位 -->
                <div>
                    <h3 class="text-base font-bold text-gray-500 uppercase tracking-wider mb-4">轉介單位</h3>
                    <div class="flex flex-wrap gap-y-2 gap-x-6">
                        <label class="w-auto"><input type="radio" name="referral" value="Self"> 自行就診</label>
                        <div class="flex items-center w-full sm:w-auto">
                            <label class="w-auto mr-2"><input type="radio" name="referral" value="Other" class="toggle-other" data-target="ref_other"> 其他機構</label>
                            <input type="text" id="ref_other" class="input-underline flex-1 min-w-[150px] opacity-50 focus:opacity-100" placeholder="機構名稱" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-base font-bold text-gray-500 uppercase tracking-wider mb-4">最近是否有遭遇重大的事件？</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 grid-gap-tablet">
                    <label><input type="checkbox" name="events" value="家人生病/過世"> 家人生病/過世</label>
                    <label><input type="checkbox" name="events" value="失業"> 失業</label>
                    <label><input type="checkbox" name="events" value="經濟困難"> 經濟困難</label>
                    <label><input type="checkbox" name="events" value="意外/天災"> 意外/天災</label>
                </div>
                <!-- 重大事件的其他欄位 -->
                <div class="mt-4 flex items-center w-full">
                    <label class="w-auto mr-3 text-gray-700 whitespace-nowrap">
                        <input type="checkbox" name="events" value="Other" class="toggle-other-check" data-target="event_other"> 其他：
                    </label>
                    <input type="text" id="event_other" class="input-underline flex-1 opacity-50 disabled:cursor-not-allowed" placeholder="請敘述..." disabled>
                </div>
            </div>

            <div class="mt-10">
                <h3 class="text-base font-bold text-gray-500 uppercase tracking-wider mb-4">目前使用藥物</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 grid-gap-tablet">
                    <label><input type="checkbox" name="meds" value="憂鬱症藥物"> 憂鬱症藥物</label>
                    <label><input type="checkbox" name="meds" value="失眠藥物"> 失眠藥物</label>
                    <label><input type="checkbox" name="meds" value="甲狀腺藥物"> 甲狀腺藥物</label>
                    <label><input type="checkbox" name="meds" value="荷爾蒙藥物"> 荷爾蒙藥物</label>
                </div>
            </div>
        </div>

        <!-- 主訴 -->
        <div class="section-card">
            <div class="section-title">2. 就醫目的與主訴</div>
            
            <div class="mb-8">
                <span class="text-gray-700 font-bold text-lg block mb-3">就醫目的：</span>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 grid-gap-tablet items-start">
                    <label><input type="checkbox" name="purpose" value="評估身體狀況"> 評估身體狀況</label>
                    <label><input type="checkbox" name="purpose" value="申請補助"> 申請補助</label>
                    <label><input type="checkbox" name="purpose" value="機構需求"> 機構需求</label>
                    <div class="col-span-1 sm:col-span-2 md:col-span-1">
                        <label class="w-auto">
                            <input type="checkbox" name="purpose" value="Other" class="toggle-other-check" data-target="purpose_other"> 其他
                        </label>
                        <input type="text" id="purpose_other" class="reveal-input input-underline w-full" placeholder="請輸入其他目的">
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-bold text-lg mb-3">主要問題描述 (CC)：</label>
                <textarea id="main_problem" rows="3" class="input-box bg-gray-50" placeholder="例如：自覺記憶變差，約一年左右..."></textarea>
            </div>
        </div>

        <!-- AD8 -->
        <div class="section-card">
            <div class="flex flex-wrap justify-between items-center mb-6 border-b pb-4">
                <div class="section-title mb-0 border-none">3. AD8 極早期失智症篩檢</div>
                <div class="text-base bg-blue-50 px-5 py-2 rounded-full font-bold text-blue-700 transition-colors border border-blue-100" id="ad8_badge">
                    得分：<span id="ad8_score" class="text-2xl">0</span> / 8
                </div>
            </div>
            <p class="text-base text-gray-500 mb-6 italic pl-2">請勾選「過去幾年與以前相比」有明顯改變的項目：</p>
            
            <div class="grid gap-4">
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_1"> 
                    <span>1. 判斷力上的困難（如落入圈套、財務決定錯誤）</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_2"> 
                    <span>2. 對活動和嗜好的興趣降低</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_3"> 
                    <span>3. 重複相同問題、故事和陳述</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_4"> 
                    <span>4. 學習使用工具、設備上有困難（遙控器、家電）</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_5"> 
                    <span>5. 忘記正確的月份和年份</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_6"> 
                    <span>6. 處理複雜財物有困難（稅單、帳單）</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_7"> 
                    <span>7. 記住約會的時間有困難</span>
                </label>
                <label class="hover:bg-gray-50 p-4 rounded-xl transition-colors border border-transparent hover:border-gray-100 shadow-sm hover:shadow">
                    <input type="checkbox" class="ad8-item" name="ad8_8"> 
                    <span>8. 有持續的思考和記憶方面的問題</span>
                </label>
            </div>
        </div>

        <!-- 皮質功能 -->
        <div class="section-card">
            <div class="section-title">4. 皮質功能評估</div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-16 gap-y-10">
                
                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">執行能力</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_exec" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_exec', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_exec', '異常')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">行為表現</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_beha" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_beha', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_beha', '異常')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">空間感</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_spatial" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_spatial', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_spatial', '迷路')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">語言理解</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_lang" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_lang', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_lang', '異常')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">記憶力</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_mem" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_mem', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_mem', '受損')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <span class="font-bold text-gray-700 text-lg">視覺辨識</span>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="cortical_visual" class="input-box flex-1" placeholder="描述或留空">
                        <div class="flex gap-2">
                            <button type="button" onclick="setValue('cortical_visual', '正常')" class="btn-pill btn-normal">正常</button>
                            <button type="button" onclick="setValue('cortical_visual', '異常')" class="btn-pill btn-abnormal">異常</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 睡眠與 BPSD -->
        <div class="section-card">
            <div class="section-title">5. 睡眠與精神行為症狀</div>
            
            <div class="mb-10">
                <h4 class="font-bold text-gray-600 text-lg mb-5 border-b pb-2">睡眠評估</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                    <!-- 昏睡 -->
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                        <div class="flex items-center min-w-[150px]">
                            <span class="font-bold mr-4 text-lg w-28">昏睡/嗜睡</span>
                            <div class="flex gap-4">
                                <label class="w-auto"><input type="radio" name="sleep_lethargy" value="No" class="toggle-sleep" checked> 無</label>
                                <label class="w-auto"><input type="radio" name="sleep_lethargy" value="Yes" class="toggle-sleep" data-target="lethargy_detail"> 有</label>
                            </div>
                        </div>
                        <input type="text" id="lethargy_detail" class="input-underline flex-1 opacity-0 transition-opacity" placeholder="頻率/狀況" disabled>
                    </div>
                    <!-- 失眠 -->
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                        <div class="flex items-center min-w-[150px]">
                            <span class="font-bold mr-4 text-lg w-28">失眠</span>
                            <div class="flex gap-4">
                                <label class="w-auto"><input type="radio" name="sleep_insomnia" value="No" class="toggle-sleep" checked> 無</label>
                                <label class="w-auto"><input type="radio" name="sleep_insomnia" value="Yes" class="toggle-sleep" data-target="insomnia_detail"> 有</label>
                            </div>
                        </div>
                        <input type="text" id="insomnia_detail" class="input-underline flex-1 opacity-0 transition-opacity" placeholder="狀況描述" disabled>
                    </div>
                    <!-- RBD (移除打鬥文字) -->
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3 md:col-span-2">
                        <div class="flex items-center min-w-[150px]">
                            <span class="font-bold mr-4 text-lg w-28">RBD</span>
                            <div class="flex gap-4">
                                <label class="w-auto"><input type="radio" name="sleep_rbd" value="No" class="toggle-sleep" checked> 無</label>
                                <label class="w-auto"><input type="radio" name="sleep_rbd" value="Yes" class="toggle-sleep" data-target="rbd_detail"> 有</label>
                            </div>
                        </div>
                        <input type="text" id="rbd_detail" class="input-underline flex-1 opacity-0 transition-opacity" placeholder="夢遊/打鬥狀況描述" disabled>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-bold text-gray-600 text-lg mb-5 border-b pb-2">精神行為 (BPSD)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 個性改變 -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">個性改變</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_personality" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_personality" value="Yes" class="toggle-bpsd" data-target="pers_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="pers_detail" class="input-box text-base hidden" placeholder="詳述改變...">
                    </div>

                    <!-- 不適切行為 -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">不適切行為</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_behavior" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_behavior" value="Yes" class="toggle-bpsd" data-target="behav_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="behav_detail" class="input-box text-base hidden" placeholder="詳述行為...">
                    </div>

                    <!-- 語無倫次 -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">言語語無倫次</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_speech" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_speech" value="Yes" class="toggle-bpsd" data-target="speech_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="speech_detail" class="input-box text-base hidden" placeholder="詳述...">
                    </div>

                    <!-- 視幻覺 (VH) -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">視幻覺 (VH)</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_visual_hallucination" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_visual_hallucination" value="Yes" class="toggle-bpsd" data-target="v_hallu_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="v_hallu_detail" class="input-box text-base hidden" placeholder="詳述視幻覺...">
                    </div>

                    <!-- 聽幻覺 (AH) -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">聽幻覺 (AH)</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_auditory_hallucination" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_auditory_hallucination" value="Yes" class="toggle-bpsd" data-target="a_hallu_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="a_hallu_detail" class="input-box text-base hidden" placeholder="詳述聽幻覺...">
                    </div>

                    <!-- 妄想 -->
                    <div class="bpsd-row bg-gray-50 p-5 rounded-xl border border-transparent shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-bold text-lg">妄想 (被害/被偷)</span>
                            <div class="flex gap-4">
                                <label class="w-auto mr-2"><input type="radio" name="bpsd_delusion" value="No" class="toggle-bpsd" checked> 否</label>
                                <label class="w-auto"><input type="radio" name="bpsd_delusion" value="Yes" class="toggle-bpsd" data-target="delu_detail"> 是</label>
                            </div>
                        </div>
                        <input type="text" id="delu_detail" class="input-box text-base hidden" placeholder="詳述妄想內容...">
                    </div>
                </div>
            </div>
        </div>

        <!-- 摘要區塊 (靜態底部) -->
        <div class="mt-12 pt-8 border-t-2 border-dashed border-gray-300 pb-12">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">English Note (Summary)</h2>
                <button type="button" onclick="copySummary()" class="bg-gray-800 hover:bg-black text-white px-8 py-3 rounded-lg shadow-lg transition-all active:scale-95 text-lg font-semibold">
                    複製摘要 (Copy)
                </button>
            </div>
            <textarea id="summaryOutput" rows="8" class="w-full bg-white border border-gray-300 rounded-xl p-6 font-mono text-base leading-relaxed text-gray-700 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none shadow-inner" readonly></textarea>
        </div>

    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // AD8 計分
            document.querySelectorAll('.ad8-item').forEach(cb => cb.addEventListener('change', updateAD8));

            // Radio Button - Other Input Toggle
            document.querySelectorAll('input[type="radio"][name]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const name = e.target.name;
                    // Find if there's an "Other" option in this group
                    const otherRadio = document.querySelector(`input[name="${name}"].toggle-other`);
                    if (otherRadio) {
                        const targetId = otherRadio.getAttribute('data-target');
                        const targetInput = document.getElementById(targetId);
                        if (targetInput) {
                            if (otherRadio.checked) {
                                targetInput.disabled = false;
                                targetInput.classList.remove('opacity-50');
                                targetInput.focus();
                            } else {
                                targetInput.disabled = true;
                                targetInput.classList.add('opacity-50');
                                targetInput.value = ''; // Optional: clear when unchecked
                            }
                        }
                    }
                });
            });

            // Checkbox - Other Input Toggle
            document.querySelectorAll('.toggle-other-check').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const targetId = e.target.getAttribute('data-target');
                    const target = document.getElementById(targetId);
                    if (target) {
                        if (e.target.checked) {
                            target.disabled = false;
                            target.classList.remove('opacity-50', 'disabled:cursor-not-allowed');
                            target.classList.add('show'); // For reveal-input class
                            target.focus();
                        } else {
                            target.disabled = true;
                            target.classList.add('opacity-50', 'disabled:cursor-not-allowed');
                            target.classList.remove('show');
                            target.value = '';
                        }
                    }
                });
            });

            // Sleep Inputs Logic
            document.querySelectorAll('.toggle-sleep').forEach(radio => {
                radio.addEventListener('change', (e) => {
                   const targetId = e.target.getAttribute('data-target');
                   if(targetId) { // This is the "Yes" button
                       const input = document.getElementById(targetId);
                       input.disabled = false;
                       input.classList.remove('opacity-0');
                       input.focus();
                   } else { // This is the "No" button
                       // Find sibling yes button to know which input to hide
                       const name = e.target.name;
                       const yesBtn = document.querySelector(`input[name="${name}"][data-target]`);
                       if(yesBtn) {
                           const input = document.getElementById(yesBtn.getAttribute('data-target'));
                           input.disabled = true;
                           input.classList.add('opacity-0');
                           input.value = '';
                       }
                   }
                });
            });

            // BPSD Inputs Logic (Show/Hide)
            document.querySelectorAll('.toggle-bpsd').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const targetId = e.target.getAttribute('data-target');
                    if(targetId) { // Yes
                        document.getElementById(targetId).classList.remove('hidden');
                        document.getElementById(targetId).focus();
                    } else { // No
                        const name = e.target.name;
                        const yesBtn = document.querySelector(`input[name="${name}"][data-target]`);
                        if(yesBtn) {
                            const input = document.getElementById(yesBtn.getAttribute('data-target'));
                            input.classList.add('hidden');
                            input.value = '';
                        }
                    }
                });
            });

            // Global listener for summary update
            document.getElementById('assessmentForm').addEventListener('input', updateSummary);
            updateSummary();
        });

        // 皮質功能一鍵填入
        function setValue(inputId, text) {
            const input = document.getElementById(inputId);
            input.value = text;
            updateSummary();
        }

        function updateAD8() {
            const score = document.querySelectorAll('.ad8-item:checked').length;
            const badge = document.getElementById('ad8_badge');
            document.getElementById('ad8_score').innerText = score;
            
            if (score >= 2) {
                badge.className = "text-base bg-red-50 px-5 py-2 rounded-full font-bold text-red-700 transition-colors border border-red-100";
            } else {
                badge.className = "text-base bg-blue-50 px-5 py-2 rounded-full font-bold text-blue-700 transition-colors border border-blue-100";
            }
            updateSummary();
        }

        function getVal(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : '';
        }

        function getText(id) {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        }

        function getMultiVal(name, otherId = null) {
            const checked = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`));
            const values = checked.map(c => {
                if (c.value === 'Other' && otherId) {
                    return getText(otherId) || '其他';
                }
                return c.value;
            });
            return values.join('、');
        }

        function updateSummary() {
            // Permit
            const permit = document.getElementById('research_consent').checked ? 'Yes' : 'No';

            // Provider
            let provider = getVal('relationship');
            if (provider === 'Other') provider = getText('rel_other');
            
            // From
            let from = getVal('referral');
            if (from === 'Other') from = getText('ref_other');

            // RxHx (Chinese)
            const meds = getMultiVal('meds') || '無';

            // Major Event (Chinese)
            const events = getMultiVal('events', 'event_other') || '無';

            // EvalFor (Chinese)
            const purpose = getMultiVal('purpose', 'purpose_other') || '無';

            // CC
            const cc = getText('main_problem').replace(/\n/g, ' ');

            // AD8
            const ad8Score = document.getElementById('ad8_score').innerText;

            // Cortical Function (Text Inputs)
            const exec = getText('cortical_exec') || '';
            const behavior = getText('cortical_beha') || '';
            const spatial = getText('cortical_spatial') || '';
            const lang = getText('cortical_lang') || '';
            const mem = getText('cortical_mem') || '';
            const visual = getText('cortical_visual') || '';

            // Sleep
            let sleepStr = [];
            if (getVal('sleep_lethargy') === 'Yes') {
                let d = getText('lethargy_detail');
                sleepStr.push(`Drowsy+${d ? '['+d+']' : ''}`);
            }
            if (getVal('sleep_insomnia') === 'Yes') {
                let d = getText('insomnia_detail');
                sleepStr.push(`Insomnia+${d ? '['+d+']' : ''}`);
            }
            if (getVal('sleep_rbd') === 'Yes') {
                let d = getText('rbd_detail');
                sleepStr.push(`RBD+${d ? '['+d+']' : ''}`);
            }
            const sleepLine = sleepStr.length > 0 ? sleepStr.join(', ') : 'No Significant Issue';

            // BPSD Helper
            function getBpsdStr(key, detailId, label) {
                if (getVal(key) === 'Yes') {
                    let d = getText(detailId);
                    if (d) return `${label}[${d}]`;
                    return label;
                }
                return null;
            }

            let bpsdItems = [];
            let p = getBpsdStr('bpsd_personality', 'pers_detail', 'personality');
            if (p) bpsdItems.push(p);
            
            let b = getBpsdStr('bpsd_behavior', 'behav_detail', 'behavior');
            if (b) bpsdItems.push(b);
            
            let s = getBpsdStr('bpsd_speech', 'speech_detail', 'Incoherence');
            if (s) bpsdItems.push(s);
            
            const bpsdFlag = bpsdItems.length > 0 ? '+' : '-';
            const bpsdLine = `BPSD(${bpsdFlag}${bpsdItems.length ? ', ' + bpsdItems.join(', ') : ''})`;

            // VH (New)
            const vhVal = getVal('bpsd_visual_hallucination');
            let vhStr = 'VH(-)';
            if (vhVal === 'Yes') {
                let d = getText('v_hallu_detail');
                vhStr = `VH(+${d ? ', ['+d+']' : ''})`;
            }

            // AH (New)
            const ahVal = getVal('bpsd_auditory_hallucination');
            let ahStr = 'AH(-)';
            if (ahVal === 'Yes') {
                let d = getText('a_hallu_detail');
                ahStr = `AH(+${d ? ', ['+d+']' : ''})`;
            }

            // Delusion
            const deluVal = getVal('bpsd_delusion');
            let delu = ', Delusion(-)';
            if (deluVal === 'Yes') {
                let d = getText('delu_detail');
                delu = `, Delusion(+${d ? ', ['+d+']' : ''})`;
            }

            // Final String Construction
            const summary = `Dementia (permit: ${permit}), Provider=${provider}, From =${from}, RxHx=${meds}, Major event=${events}, EvalFor=${purpose}, CC=${cc}, AD8=${ad8Score}, Exec=${exec}, Spatial=${spatial}, Mem=${mem}, Beha=${behavior}, Lang=${lang}, Visual=${visual}, Sleep (${sleepLine}), ${bpsdLine}, ${vhStr}, ${ahStr}${delu}`;

            document.getElementById('summaryOutput').value = summary;
        }

        function copySummary() {
            const copyText = document.getElementById("summaryOutput");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            
            const btn = document.querySelector('button[onclick="copySummary()"]');
            const originalText = btn.innerText;
            btn.innerText = "已複製 (Copied!)";
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.classList.remove('bg-gray-800', 'hover:bg-black');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-800', 'hover:bg-black');
            }, 2000);
        }
    </script>
</body>
</html>
